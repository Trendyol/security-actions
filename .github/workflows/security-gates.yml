name: security-gates

on:
  workflow_call:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  security-gates-check:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Determine repository visibility
        id: drv
        run: |
          visibility=$(gh api /repos/$GITHUB_REPOSITORY --jq '.visibility')
          echo "visibility=$visibility" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Gitleaks
      - name: Install & Run Gitleaks
        run: |
          arc=$(uname -p)
          [ "$arc" = "x86_64" ] && arc="x64"
          os=$(uname -s | tr '[:upper:]' '[:lower:]')
          gitleaksVersion="8.22.1"
          gl_full="gitleaks_${gitleaksVersion}_${os}_${arc}.tar.gz"
          wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${gitleaksVersion}/${gl_full}"
          tar -xzf "$gl_full"
          if [ "${{ steps.drv.outputs.visibility }}" == "public" ]; then
            ./gitleaks detect -f sarif -r gitleaks.sarif --redact --exit-code 1
          else
            ./gitleaks detect --redact --exit-code 1
          fi

      - uses: github/codeql-action/upload-sarif@v3
        if: steps.drv.outputs.visibility == 'public'
        with:
          sarif_file: gitleaks.sarif

      # Semgrep
      - name: Install & Run Semgrep
        run: |
          pip install semgrep
          if [ "${{ steps.drv.outputs.visibility }}" == "public" ]; then
            semgrep ci --config=auto --sarif --output=semgrep.sarif
          else
            semgrep ci --config=auto --text
          fi

      - uses: github/codeql-action/upload-sarif@v3
        if: steps.drv.outputs.visibility == 'public'
        with:
          sarif_file: semgrep.sarif

      # SBOM Scan (Grype)
      - name: Run Anchore SBOM Scan
        uses: anchore/scan-action@v3
        with:
          path: "."
          output-format: ${{ steps.drv.outputs.visibility == 'public' && 'sarif' || 'table' }}
          fail-build: false
        id: scan

      - uses: github/codeql-action/upload-sarif@v3
        if: steps.drv.outputs.visibility == 'public'
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
